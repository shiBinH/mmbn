<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>Test</title>
		<style>
			body { margin: 0;}
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
		<audio id="audio-background" autoplay>
			<source src="audio/mmx2-zero-theme.mp3" type="audio/mpeg">
		</audio>
		<audio>
		</audio>
		<script src="scripts/three.min.js"></script>
		<script>
			var lookLeft;
			var projectile;
			var fireRay
			var fire;
			var target;
			var objects = [];
			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );
			
			var camera = new THREE.PerspectiveCamera( 70, window.innerWidth/window.innerHeight, 10, 300 );
			camera.position.set( 0, 45, 100 );
			var scene = new THREE.Scene();
			scene.background = new THREE.TextureLoader().load('images/background-x2.jpg');

			var group = new THREE.Group();
			var material;
			var sphere;
			var geometry;
			geometry = new THREE.SphereGeometry(2);
			material = new THREE.MeshBasicMaterial({color: new THREE.Color('yellow')});
			group.add(new THREE.Mesh(geometry, material))
			geometry = new THREE.SphereGeometry(6);
			material = new THREE.MeshBasicMaterial({wireframe: true, color: new THREE.Color('green')});
			sphere = new THREE.Mesh(geometry, material);
			group.add(sphere);
			scene.add(group);
			geometry = new THREE.SphereGeometry(6);
			material = new THREE.MeshBasicMaterial({wireframe: true, color: new THREE.Color('orange')});
			target = new THREE.Mesh(geometry, material);
			target.hitStart = null;
			target.position.set(90, 6, 0);
			target.HP = 3;
			scene.add(target);
			var velocity = new THREE.Vector3();
			var up = false, down = false, left = false, right = false, canJump = true;
			var prevTime;
			projectile = null;
			document.addEventListener('keydown', function(e) {
				var key = String.fromCharCode(e.keyCode);
				switch(key) {
					case 'G':
						left = true; lookLeft = true; break;
					case 'J':
						right = true; lookLeft = false; break;
					case 'Z':
						if (canJump) velocity.y += 200;
						canJump = false;
						break;
					case 'X':
						fire = true;
						if (projectile === null) {
							geometry = new THREE.SphereGeometry(1);
							material = new THREE.MeshBasicMaterial({color: new THREE.Color('yellow')});
							projectile = new THREE.Mesh(geometry, material);
							projectile.position.copy(group.position);
							var Vx = lookLeft ? -200 : 200;
							projectile.velocity = new THREE.Vector3(Vx, 0, 0);
							fireRay = new THREE.Raycaster(new THREE.Vector3(), new THREE.Vector3(Vx < 0? -1 : 1, 0, 0), 0, 6);
							scene.add(projectile)
						}
						break;
					case 'P':
						var audio = document.getElementById('play');
						if (audio.paused) audio.play();
						else audio.pause();
				}
			})
			document.addEventListener('keyup', function(e) {
				var key = String.fromCharCode(e.keyCode);
				switch(key) {
					case 'G':
						left = false; break;
					case 'J':
						right = false; break;
					case 'X':
						fire = false; break;
				}
			})

			geometry = new THREE.Geometry();
			geometry.vertices.push(new THREE.Vector3(-100, 0, 0));
			geometry.vertices.push(new THREE.Vector3(100, 0, 0))
			material = new THREE.LineBasicMaterial({color: new THREE.Color('white')});
			scene.add(new THREE.Line(geometry, material));
			geometry = new THREE.Geometry();
			geometry.vertices.push(new THREE.Vector3(-80, 30, 0));
			geometry.vertices.push(new THREE.Vector3(-30, 30, 0));
			objects.push(new THREE.Line(geometry, material));
			scene.add(objects[objects.length-1]);
			geometry = new THREE.Geometry();
			geometry.vertices.push(new THREE.Vector3(-30, 60, 0));
			geometry.vertices.push(new THREE.Vector3(10, 60, 0));
			objects.push(new THREE.Line(geometry, material));
			scene.add(objects[objects.length-1]);
			geometry = new THREE.Geometry();
			geometry.vertices.push(new THREE.Vector3(30, 40, 0));
			geometry.vertices.push(new THREE.Vector3(90, 40, 0));
			objects.push(new THREE.Line(geometry, material));
			scene.add(objects[objects.length-1]);
			geometry = new THREE.Geometry();
			geometry.vertices.push(new THREE.Vector3(-100, 80, 0));
			geometry.vertices.push(new THREE.Vector3(-80, 80, 0));
			objects.push(new THREE.Line(geometry, material));
			scene.add(objects[objects.length-1]);
			/*
			geometry = new THREE.BoxGeometry(20, 20, 20);
			material = new THREE.MeshBasicMaterial({color: new THREE.Color('yellow')});
			var mesh = new THREE.Mesh(geometry, material);
			mesh.position.set(-70, 10, 0);
			mesh.HP = 1;
			mesh.hitStart = null;
			scene.add(mesh);
			*/
			mesh = null;
			
			fire = false;
			var Ray = new THREE.Raycaster(new THREE.Vector3(), new THREE.Vector3(0, -1, 0), 1, 6);
			renderer.render(scene, camera);
			//
			prevTime = performance.now();
			render();
			function render() {
				var time = performance.now();
				var delta = (time - prevTime)/1000;
				
				Ray.ray.origin.copy(group.position);
				var intersected = Ray.intersectObjects(objects);
				if (projectile !== null) {
					fireRay.ray.origin.copy(projectile.position);
					var victim = fireRay.intersectObjects(scene.children);
					var hit = victim.length > 0 ? true : false;

					if (projectile.position.x > 100 || projectile.position.x < -100) {
						scene.remove(scene.getObjectById(projectile.id));
						projectile = null;
					}
					else if (hit) {
						scene.remove(scene.getObjectById(projectile.id));
						projectile = null;
						if (victim[0].object.hitStart === null) {
							victim[0].object.material.color = new THREE.Color('red')
							victim[0].object.hitStart = performance.now();
							victim[0].object.HP--;
							if (victim[0].object.HP === 0) {
								scene.remove(victim[0].object);
							}
						}
					}
					else projectile.translateX(projectile.velocity.x * delta);

				}
				
				if (time - target.hitStart >= 1000) {
					target.material.color = new THREE.Color('orange');
					target.hitStart = null;
				}
				
				velocity.x -= velocity.x * 6 * delta;	//	deceleration
				velocity.y -= 50 * 10 * delta;	//	gravity
				
				if (intersected.length > 0) {
					velocity.y = Math.max(velocity.y, 0);
					if (velocity.y === 0) canJump = true;
					
				} 
				
				if (true) {	//	deceleration in air
					if (left) velocity.x -= delta * 500.0;
					if (right) velocity.x += delta * 500.0;
				}
				else velocity.x += delta * velocity.x * 5.5;

				group.translateX(delta * velocity.x);
				group.translateY(delta * velocity.y);
				if (group.position.y-6 < 0) {
					velocity.y = 0;
					group.position.y = 6;
					canJump = true;
				}
				if (group.position.x<-100) group.position.x = -100;
				else if (group.position.x>100) group.position.x = 100;
				
				prevTime = time;
				
				renderer.render(scene, camera);
				requestAnimationFrame(render);
			}
		</script>
	</body>
</html>